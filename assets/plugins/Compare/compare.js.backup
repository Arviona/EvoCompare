setAllCompareButtonsState();
setAllCompareButtonsListeners();
/* @NOTE: To delete setAllCompareButtonsStateAndListeners(); */

function afterFilterComplete() {
    setAllCompareButtonsState();
    setAllCompareButtonsListeners();
/* @NOTE: To delete setAllCompareButtonsStateAndListeners(); */    
}

function addToCompareList(productId) {
    // Get the current comparison list from the cookie
    const compareList = getCompareList();
    
    // Check if the product is already in the comparison list
    if (!compareList.includes(productId)) {
        // Check if the comparison list has reached its limit
        if (compareList.length >= 5) {
            showCompareListLimitWarning();
            return;
        }
        
        // Add the product to the comparison list
        compareList.push(productId);
        updateCompareListCookie(compareList);
        
        // Update the button text and class
        updateCompareButtonState(productId);
    }      
}

function removeFromCompareList(productId) {
    // Get the current comparison list from the cookie
    const compareList = getCompareList();
    
    // Check if the product is in the comparison list
    if (compareList.includes(productId)) {
        // Remove the product from the comparison list
        const index = compareList.indexOf(productId);
        compareList.splice(index, 1);
        updateCompareListCookie(compareList);
        
        // Update the button text and class
        updateCompareButtonState(productId);

        // Update comparison table
        const table_wrapper = document.querySelector('[data-role="compare-list-table"]');
        if (table_wrapper) {
            renderComparisonTable(table_wrapper); 
        }           
    }
}


function setAllCompareButtonsListeners() {
    // Add event listener to the each compare button
    const compareButtons = document.querySelectorAll("[data-role='compareButton']");
    if (compareButtons.length == 0) {
        return;
    }
    
    compareButtons.forEach(button => {
        button.addEventListener("click", function() {
            const productId = this.dataset.id;
            const action = this.dataset.action;
            if (action === "addToCompareList") {
                addToCompareList(productId);
            } else if (action === "removeFromCompareList") {
                removeFromCompareList(productId);
            }
        });
    });
}



function setAllCompareButtonsState() {
    // Set class and text to the each compare button
    
    // Get the current comparison list from the cookie
    const compareList = getCompareList();
    if (compareList.length == 0) {
        return;
    }

   compareList.forEach(productId => {
        const button = document.querySelector(`[data-id='${productId}']`);

        button.innerText = "Удалить из сравнения";
        button.dataset.action = "removeFromCompareList";
        button.classList.add("in_compare");        
        button.addEventListener("click", function() { removeFromCompareList(this.dataset.id); });
    });
}

/* @NOTE: To delete
function setAllCompareButtonsStateAndListeners() {
    // Set class and text to the each compare button
    const compareButtons = document.querySelectorAll("[data-role='compareButton']");
    if (compareButtons.length == 0) {
        return;
    }
    
    // Get the current comparison list from the cookie
    const compareList = getCompareList();
    
    compareButtons.forEach(button => {
        const productId = button.dataset.id;
        
        // Check if the product is in the comparison list
        if (compareList.includes(productId)) {
            button.innerText = "Удалить из сравнения";
            button.dataset.action = "removeFromCompareList";
            button.classList.add("in_compare");
            
            button.addEventListener("click", function() { removeFromCompareList(this.dataset.id); });
        } else {
            button.innerText = "Сравнить";
            button.dataset.action = "addToCompareList";
            button.classList.remove("in_compare");

            button.addEventListener("click", function() { addToCompareList(this.dataset.id); });
        }
    });
} */

function updateCompareButtonState(productId) {
    // Find the corresponding compare button for the product
    const compareButton = document.querySelector(`[data-id='${productId}']`);
    if (!compareButton) {
        return;
    }
    
    // Get the current comparison list from the cookie
    const compareList = getCompareList();
    
    // Check if the product is in the comparison list
    if (compareList.includes(productId)) {
        compareButton.innerText = "Удалить из сравнения";
        compareButton.dataset.action = "removeFromCompareList";
        compareButton.classList.add("in_compare");

        compareButton.addEventListener("click", function() { removeFromCompareList(this.dataset.id); });
    } else {
        compareButton.innerText = "Сравнить";
        compareButton.dataset.action = "addToCompareList";
        compareButton.classList.remove("in_compare");

        compareButton.addEventListener("click", function() { addToCompareList(this.dataset.id); });
    }
}


function getCompareList() {
    // Check if the cookie exists
    if (document.cookie.indexOf("compare_list") === -1) {
        return [];
    }
    
    // Extract the comparison list from the cookie
    const compareListCookie = document.cookie.split(";").find(cookie => cookie.trim().startsWith("compare_list="));
    const compareList = compareListCookie.split("=")[1].split(",");
    
    return compareList;
}


function updateCompareListCookie(compareList) {
    if (compareList.length > 0) {
        // Convert the comparison list array into a string
        const compareListString = compareList.join(",");
        
        // Set the cookie with the updated comparison list
        document.cookie = `compare_list=${compareListString};max-age=31536000;path=/`;
    } else {
        // Delete coockie
        document.cookie = "compare_list=;max-age=-1;path=/";
    }
}


function showCompareListLimitWarning() {
    alert("You can only compare up to 5 products at a time. Please remove a product from the comparison list to add a new one.");
}


function renderComparisonTable(wrapper_selector) {
    const compareList = getCompareList();
    if (compareList.length === 0) {
        return;
    }
    
    fetch("/compare-list-render", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ products: compareList })
    })
    .then(response => response.text())
    .then(html => {
        wrapper_selector.innerHTML = html;
    });
}
